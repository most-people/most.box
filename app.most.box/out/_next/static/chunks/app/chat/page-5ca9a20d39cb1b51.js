(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8457],{13422:(e,t,r)=>{Promise.resolve().then(r.bind(r,80262))},38639:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});let n="IPv6 (Internet Protocol version 6) 是下一代互联网的核心协议，旨在解决 IPv4 地址枯竭问题并提升网络性能。\r\n\r\n**核心功能：每个设备可拥有全球唯一公网 IP，消除对 NAT 的依赖，回归端到端通信。**\r\n\r\n- IPv4 的 32 位地址（约 43 亿个）已耗尽。IPv6 采用 128 位地址，提供近乎无限的地址空间，满足物联网、5G 等海量设备连接需求。\r\n\r\n- [test-ipv6.com](https://test-ipv6.com) | [itdog.cn](https://www.itdog.cn/localhost/) | [ipw.cn](https://ipw.cn) | [test6.ustc.edu.cn](https://test6.ustc.edu.cn) 可以测试当前网络是否支持 IPv6\r\n"},80262:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>O});var n=r(95155),a=r(90101),i=r(13947),s=r(21794),o=r(13877),c=r(2369),l=r(40387),d=r(67661),u=r(74264),h=r(17998),g=r(82726),p=r(60688),f=r(93852),m=r(9457),x=r(58380),y=r(96778),w=r(70305),j=r(21179),b=r(67623),v=r(92364),T=r(44634),S=r(59126),C=r(93027),k=r(64998),R=r(86804),P=r(99853),I=r(43643),D=r(15884),B=r(12115),E=r(38639),z=r(13297),A=r(61505),G=r(97443);function O(){var e;let[t,r]=(0,B.useState)(""),[O,L]=(0,B.useState)("001"),[U,V]=(0,B.useState)(null),[N,W]=(0,B.useState)(!1),[F,H]=(0,B.useState)(!1),[_,M]=(0,B.useState)("new"),[J,K]=(0,B.useState)("new"),[Y,q]=(0,B.useState)(null),[Q,X]=(0,B.useState)(!0),[Z,$]=(0,B.useState)(!1),[ee,et]=(0,B.useState)(!1),er=(0,B.useRef)(null),en=(0,B.useRef)(null),ea=(0,B.useRef)(null),ei=(0,B.useRef)(null),es=(0,B.useRef)(null),eo=(0,B.useRef)([]),ec=(0,B.useRef)(null),el=(0,B.useRef)(null),ed=(0,B.useRef)(null),[eu,eh]=(0,B.useState)(!1),[eg,ep]=(0,B.useState)([]),[ef,em]=(0,B.useState)("");(0,B.useEffect)(()=>{ec.current=U},[U]),(0,B.useEffect)(()=>{if(!N||!en.current)return;let e=setInterval(()=>{let e=en.current;if(e){let t=e.connectionState,r=e.iceConnectionState;t!==_&&M(t),r!==J&&K(r);let n="connected"===t&&("connected"===r||"completed"===r);n!==F&&H(n)}},2e3);return()=>clearInterval(e)},[N,_,J,F]);let ex=e=>{let t=new URL(window.location.href);e!==t.searchParams.get("id")&&(t.searchParams.set("id",e),window.history.replaceState({},"",t.href))},ey=N?"已".concat(U?"".concat("creator"===U?"创建":"加入"):""):"未连接",ew=N?"green":"gray",ej=F?"P2P已连接":"P2P未连接",eb=F?"green":"connecting"===_?"yellow":"gray",ev=async e=>{if(e)try{await e.play()}catch(e){console.info("视频播放失败",e)}},eT=async(e,t)=>{es.current=t,ea.current&&(ea.current.srcObject=t,await ev(ea.current)),t.getTracks().forEach(r=>e.addTrack(r,t));let r=t.getAudioTracks(),n=t.getVideoTracks();et(n.length>0),X(r.length>0&&r.every(e=>e.enabled)),$(n.length>0&&n.every(e=>e.enabled))},eS=async()=>{try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:{width:640,height:360}})}catch(e){console.info("获取视频失败",e),S.notifications.show({message:"请检查摄像头权限",color:"orange"});try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(e){console.info("获取音频失败",e),S.notifications.show({message:"请检查麦克风权限",color:"orange"})}}},eC=async e=>{if(eo.current.length)for(let t of eo.current.splice(0))try{await e.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.info("添加 ICE 候选失败",e)}},ek=async(e,t)=>{await e.setRemoteDescription(new RTCSessionDescription(t)),await eC(e)},eR=async(e,t)=>{try{e.remoteDescription?await e.addIceCandidate(new RTCIceCandidate(t)):eo.current.push(t)}catch(e){console.info("添加 ICE 候选失败",e)}},eP=async e=>{try{await fetch("".concat(s.FH.getUri(),"/api.signaling"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.info("发送信号失败",e)}},eI=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];ep(n=>[...n,{id:Date.now()+Math.random(),from:e,text:t,ts:Date.now(),self:r}])},eD=e=>{el.current=e,e.onopen=()=>{eh(!0),S.notifications.show({message:"文字通道已建立",color:"green"})},e.onmessage=e=>{eI("远端","string"==typeof e.data?e.data:"[非文本消息]",!1)},e.onclose=()=>{eh(!1),S.notifications.show({message:"文字通道已关闭",color:"orange"})},e.onerror=()=>{S.notifications.show({message:"文字通道出错",color:"red"})}},eB=()=>{let e=el.current,t=ef.trim();if(t){if(!e||"open"!==e.readyState)return void S.notifications.show({message:"通道未就绪，无法发送",color:"orange"});e.send(t),eI("本地",t,!0),em("")}};(0,B.useEffect)(()=>{let e=ed.current;e&&(e.scrollTop=e.scrollHeight)},[eg]);let eE=async()=>{try{let e=await s.FH.get("/api.room",{params:{roomId:O}});if(e.data.ok)return e.data.users}catch(e){console.info("获取房间用户失败",e)}},ez=async()=>{let e=en.current;if(e)try{let t=await e.getStats(),r={};t.forEach(e=>{"candidate-pair"===e.type&&"succeeded"===e.state&&(r.candidatePair={bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,currentRoundTripTime:e.currentRoundTripTime,availableOutgoingBitrate:e.availableOutgoingBitrate}),"inbound-rtp"===e.type&&"video"===e.mediaType&&(r.inboundVideo={bytesReceived:e.bytesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,framesDecoded:e.framesDecoded}),"outbound-rtp"===e.type&&"video"===e.mediaType&&(r.outboundVideo={bytesSent:e.bytesSent,packetsSent:e.packetsSent,framesEncoded:e.framesEncoded})}),q(r),console.log("连接统计信息:",r)}catch(e){console.error("获取连接统计失败:",e)}},eA=async()=>{let e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.nextcloud.com:443"},{urls:"stun:stun.freeswitch.org:3478"}]});e.oniceconnectionstatechange=()=>{let t=e.iceConnectionState;K(t),console.log("ICE 连接状态变化:",t),"connected"===t||"completed"===t?(H(!0),S.notifications.show({message:"P2P 连接已建立！",color:"green"})):("disconnected"===t||"failed"===t)&&(H(!1),"failed"===t&&S.notifications.show({message:"P2P 连接失败，请重试",color:"red"}))},e.onconnectionstatechange=()=>{let t=e.connectionState;M(t),console.log("连接状态变化:",t),"connected"===t?(H(!0),S.notifications.show({message:"WebRTC 连接已建立！",color:"green"})):"disconnected"===t||"failed"===t?(H(!1),"failed"===t&&S.notifications.show({message:"WebRTC 连接失败",color:"red"})):"connecting"===t&&S.notifications.show({message:"正在建立 P2P 连接...",color:"blue"})},e.onicecandidate=e=>{e.candidate&&eP({roomId:O,from:t,type:"candidate",payload:e.candidate})},e.ontrack=e=>{if(!ei.current)return;let[t]=e.streams;t&&(ei.current.srcObject=t,ev(ei.current))},e.ondatachannel=e=>{eD(e.channel)};let r=es.current,n=r||await eS();if(n)if(r){ea.current&&!ea.current.srcObject&&(ea.current.srcObject=n,await ev(ea.current)),n.getTracks().forEach(t=>e.addTrack(t,n));let t=n.getAudioTracks(),r=n.getVideoTracks();et(r.length>0),X(t.length>0&&t.every(e=>e.enabled)),$(r.length>0&&r.every(e=>e.enabled))}else await eT(e,n);return en.current=e,e},eG=async()=>{try{let e=await eE();if(!e)return void S.notifications.show({message:"获取房间用户失败",color:"red"});if(e.length>=2)return void S.notifications.show({message:"房间已满，试试更换房间 ID",color:"red"});let r=0===e.length?"creator":"joiner";ec.current=r,eo.current=[],await eA(),V(r),er.current&&er.current.close();let n=new URL(s.FH.getUri());n.pathname="/sse.signaling",n.searchParams.append("roomId",O),n.searchParams.append("clientId",t);let a=new EventSource(n.href,{withCredentials:!1});if(a.onopen=()=>{var e;W(!0);let r=en.current;"joiner"===ec.current&&(null==r||null==(e=r.localDescription)?void 0:e.type)==="offer"&&eP({roomId:O,from:t,type:"offer",payload:r.localDescription})},a.onerror=e=>{console.info("SSE 连接错误",e)},a.onmessage=async e=>{try{let r=JSON.parse(e.data);if(!r||!r.type||"hello"===r.type)return;if("join"===r.type)return void S.notifications.show({message:r.clientId+" 加入房间",color:"blue"});if("leave"===r.type){S.notifications.show({message:r.clientId+" 离开房间",color:"blue"}),"joiner"===ec.current&&eO();return}let n=en.current;if(!n)return;if("offer"===r.type&&"creator"===ec.current){await ek(n,r.payload);let e=await n.createAnswer();await n.setLocalDescription(e),await eP({roomId:O,from:t,type:"answer",payload:e})}else"answer"===r.type&&"joiner"===ec.current?await ek(n,r.payload):"candidate"===r.type&&await eR(n,r.payload)}catch(e){console.info(e)}},er.current=a,"joiner"===r){let e=en.current,r=e.createDataChannel("chat",{ordered:!0});eD(r);let n=await e.createOffer();await e.setLocalDescription(n),await eP({roomId:O,from:t,type:"offer",payload:n})}}catch(e){console.info("连接失败",e)}},eO=async()=>{var e,t;if(null==(e=er.current)||e.close(),er.current=null,W(!1),V(null),H(!1),M("new"),K("new"),q(null),el.current){try{el.current.close()}catch(e){}el.current=null}eh(!1);let r=en.current;r&&(r.getSenders().forEach(e=>{try{var t;null==(t=e.track)||t.stop()}catch(e){console.info("停止发送器失败",e)}}),r.onicecandidate=null,r.ontrack=null,r.ondatachannel=null,r.close(),en.current=null),null==(t=es.current)||t.getTracks().forEach(e=>e.stop()),es.current=null,eo.current=[],et(!1),X(!1),$(!1)},eL=(0,A.B)(),eU=(0,B.useRef)(null),eV=(0,z.k)(e=>e.nodeDark),eN=async()=>{eU.current&&(await eL.initViewer(eU.current)).setMarkdown(E.A)};(0,B.useEffect)(()=>{r(Math.random().toString(36).slice(2,10).toUpperCase());let e=new URLSearchParams(window.location.search).get("id");return L(e||O),ex(e||O),eN(),()=>{eO()}},[]);let eW=async()=>{let e=es.current;if(!e){let t=await eS();if(!t)return;es.current=t,ea.current&&(ea.current.srcObject=t,await ev(ea.current));let r=t.getAudioTracks(),n=t.getVideoTracks();et(n.length>0),X(r.length>0&&r.every(e=>e.enabled)),$(n.length>0&&n.every(e=>e.enabled)),e=t}let t=e.getAudioTracks();if(!t.length)return void S.notifications.show({message:"未检测到麦克风",color:"orange"});let r=!Q;t.forEach(e=>e.enabled=r),X(r)},eF=async()=>{let e=es.current;if(!e){let t=await eS();if(!t)return;es.current=t,ea.current&&(ea.current.srcObject=t,await ev(ea.current));let r=t.getAudioTracks(),n=t.getVideoTracks();et(n.length>0),X(r.length>0&&r.every(e=>e.enabled)),$(n.length>0&&n.every(e=>e.enabled)),e=t}let t=e.getVideoTracks();if(!t.length)return void S.notifications.show({message:"未检测到摄像头",color:"orange"});let r=!Z;t.forEach(e=>e.enabled=r),$(r)};return(0,n.jsxs)(o.Container,{py:"md",children:[(0,n.jsx)(a.AppHeader,{title:"点对点聊天"}),(0,n.jsxs)(c.Stack,{gap:"md",children:[(0,n.jsx)(l.Center,{children:(0,n.jsx)(i.I,{name:"Chat",size:40})}),(0,n.jsxs)(d.Group,{justify:"space-between",align:"center",children:[(0,n.jsx)(u.Title,{size:"h2",children:"WebRTC + HTTP + SSE"}),(0,n.jsxs)(d.Group,{gap:"sm",children:[(0,n.jsx)(h.Badge,{size:"lg",color:ew,variant:"light","aria-live":"polite","aria-atomic":!0,children:ey}),N&&(0,n.jsx)(h.Badge,{size:"lg",color:eb,variant:"light","aria-label":"P2P 连接状态",children:ej})]})]}),(0,n.jsx)(g.Paper,{p:"md",withBorder:!0,radius:"md",children:(0,n.jsxs)(d.Group,{align:"flex-end",wrap:"wrap",justify:"space-between",children:[(0,n.jsx)(p.TextInput,{label:"房间 ID",description:"使用相同的房间 ID 才可建立连接",value:O,onChange:e=>{ex(e.currentTarget.value),L(e.currentTarget.value)},placeholder:"输入房间 ID",flex:1,miw:280,rightSection:(0,n.jsx)(f.CopyButton,{value:O,timeout:1e3,children:e=>{let{copied:t,copy:r}=e;return(0,n.jsx)(m.Tooltip,{label:t?"已复制":"复制",children:(0,n.jsx)(x.ActionIcon,{variant:t?"filled":"light",color:t?"teal":"gray",onClick:r,"aria-label":"复制房间ID",children:t?"✓":"⧉"})})}})}),(0,n.jsx)(d.Group,{gap:"xs",wrap:"wrap",children:N?(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(y.Button,{color:"red",variant:"light",onClick:eO,leftSection:(0,n.jsx)(C.A,{size:16}),children:"断开"})}):(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(y.Button,{onClick:()=>eG(),disabled:!t,leftSection:(0,n.jsx)(k.A,{size:16}),color:"blue",variant:"light",children:"加入"})})})]})}),N&&(0,n.jsxs)(g.Paper,{p:"md",withBorder:!0,radius:"md",children:[(0,n.jsxs)(d.Group,{justify:"space-between",align:"center",mb:"sm",children:[(0,n.jsx)(w.Text,{fw:500,children:"连接状态详情"}),(0,n.jsx)(h.Badge,{variant:"light",color:eb,children:F?"已连接":"未连接"})]}),(0,n.jsxs)(j.SimpleGrid,{cols:{base:1,sm:2},spacing:"sm",children:[(0,n.jsxs)(d.Group,{justify:"space-between",p:"xs",style:{backgroundColor:"var(--mantine-color-gray-light)",borderRadius:4},children:[(0,n.jsx)(w.Text,{size:"sm",children:"WebRTC 连接状态:"}),(0,n.jsx)(h.Badge,{size:"sm",color:"connected"===_?"green":"connecting"===_?"yellow":"gray",children:_})]}),(0,n.jsxs)(d.Group,{justify:"space-between",p:"xs",style:{backgroundColor:"var(--mantine-color-gray-light)",borderRadius:4},children:[(0,n.jsx)(w.Text,{size:"sm",children:"ICE 连接状态:"}),(0,n.jsx)(h.Badge,{size:"sm",color:"connected"===J||"completed"===J?"green":"checking"===J?"yellow":"gray",children:J})]})]}),!F&&N&&(0,n.jsx)(w.Text,{size:"sm",c:"dimmed",mt:"sm",children:"\uD83D\uDCA1 提示: 如果长时间无法建立 P2P 连接，请检查网络 IPv6 配置或尝试重新连接"}),F&&(0,n.jsxs)(d.Group,{mt:"sm",gap:"xs",children:[(0,n.jsx)(y.Button,{size:"xs",variant:"light",color:"blue",onClick:ez,children:"延迟"}),Y&&(0,n.jsxs)(w.Text,{size:"xs",c:"dimmed",children:["RTT:"," ",(null==(e=Y.candidatePair)?void 0:e.currentRoundTripTime)?"".concat((1e3*Y.candidatePair.currentRoundTripTime).toFixed(0),"ms"):"失败"]})]})]}),(0,n.jsxs)(j.SimpleGrid,{cols:{base:1,sm:2},spacing:"md",children:[(0,n.jsxs)(g.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,n.jsx)(l.Center,{children:(0,n.jsx)(w.Text,{children:"本地"})}),(0,n.jsxs)(b.Box,{style:{position:"relative"},children:[(0,n.jsx)("video",{ref:ea,playsInline:!0,autoPlay:!0,muted:!0,"aria-label":"本地媒体流视频",title:"本地媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}}),ee&&!Z&&(0,n.jsx)(l.Center,{style:{position:"absolute",inset:0,borderRadius:8,backgroundColor:"var(--mantine-color-gray-light)"},children:(0,n.jsx)(d.Group,{gap:"xs",children:(0,n.jsx)(w.Text,{size:"sm",c:"dimmed",children:"摄像头已关闭"})})})]}),(0,n.jsxs)(d.Group,{justify:"center",mt:"xs",gap:"xs",children:[(0,n.jsx)(m.Tooltip,{label:Q?"关闭麦克风":"开启麦克风",children:(0,n.jsx)(y.Button,{size:"xs",variant:Q?"light":"filled",color:Q?"green":"gray",onClick:eW,disabled:!1,"aria-pressed":Q,leftSection:Q?(0,n.jsx)(R.A,{size:16}):(0,n.jsx)(P.A,{size:16}),children:"麦克风"})}),(0,n.jsx)(m.Tooltip,{label:Z?"关闭摄像头":"开启摄像头",children:(0,n.jsx)(y.Button,{size:"xs",variant:Z?"light":"filled",color:Z?"green":"gray",onClick:eF,disabled:!1,"aria-pressed":Z,leftSection:Z?(0,n.jsx)(I.A,{size:16}):(0,n.jsx)(D.A,{size:16}),children:"摄像头"})})]})]}),(0,n.jsxs)(g.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,n.jsx)(l.Center,{children:(0,n.jsx)(w.Text,{children:"远端"})}),(0,n.jsx)("video",{ref:ei,playsInline:!0,autoPlay:!0,"aria-label":"远端媒体流视频",title:"远端媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}})]})]}),(0,n.jsxs)(g.Paper,{p:"md",withBorder:!0,radius:"md",children:[(0,n.jsxs)(d.Group,{justify:"space-between",align:"center",mb:"sm",children:[(0,n.jsx)(w.Text,{fw:500,children:"聊天"}),(0,n.jsx)(h.Badge,{variant:"light",color:eu?"green":"gray",children:eu?"可发送":"未就绪"})]}),(0,n.jsx)(b.Box,{ref:ed,style:{height:240,overflowY:"auto",backgroundColor:"var(--mantine-color-gray-light)",borderRadius:6,padding:8},children:0===eg.length?(0,n.jsx)(l.Center,{c:"dimmed",h:220,children:(0,n.jsxs)(w.Text,{size:"sm",children:["暂无消息，",N?"开始聊天吧":"请先加入建立连接"]})}):(0,n.jsx)(c.Stack,{gap:6,children:eg.map(e=>(0,n.jsxs)(b.Box,{style:{maxWidth:"75%",marginLeft:e.self?"auto":0,marginRight:e.self?0:"auto",backgroundColor:e.self?"var(--mantine-color-blue-light)":"white",border:"1px solid var(--mantine-color-gray-3)",borderRadius:8,padding:8,textAlign:e.self?"right":"left"},"aria-label":"".concat(e.from," 的消息"),title:G.A.formatDate(e.ts),children:[(0,n.jsxs)(w.Text,{size:"xs",c:"dimmed",children:[e.from," ",G.A.formatDate(e.ts)]}),(0,n.jsx)(w.Text,{size:"sm",style:{whiteSpace:"pre-wrap"},children:e.text})]},e.id))})}),(0,n.jsxs)(d.Group,{align:"flex-end",mt:"sm",wrap:"wrap",children:[(0,n.jsx)(v.Textarea,{placeholder:eu?"输入消息 Enter 发送 Shift+Enter 换行":"文字通道未就绪",value:ef,onChange:e=>em(e.currentTarget.value),autosize:!0,minRows:1,maxRows:3,style:{flex:1},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eB())}}),(0,n.jsx)(d.Group,{gap:"xs",children:(0,n.jsx)(y.Button,{onClick:eB,disabled:!eu||!ef.trim(),children:"发送"})})]})]}),(0,n.jsx)(T.Card,{withBorder:!0,children:(0,n.jsx)(b.Box,{className:eV,ref:eU})})]})]})}}},e=>{e.O(0,[8198,2545,642,2829,5619,6714,8555,8990,5125,9287,9318,9457,5939,101,8289,8441,1255,7358],()=>e(e.s=13422)),_N_E=e.O()}]);