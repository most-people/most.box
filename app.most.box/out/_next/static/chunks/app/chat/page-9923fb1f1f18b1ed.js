(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8457],{16542:(e,t,n)=>{Promise.resolve().then(n.bind(n,42047))},42047:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>D});var r=n(95155),a=n(80630),i=n(22450),c=n(54205),o=n(91590),s=n(21220),l=n(8141),d=n(70112),u=n(93751),h=n(26029),p=n(97287),f=n(8593),g=n(42445),m=n(27361),y=n(81001),w=n(26903),x=n(58887),j=n(18229),b=n(18403),v=n(69604),C=n(6942),S=n(38232),T=n(59063),R=n(12115),P=n(38639),k=n(48764),I=n(91082);function D(){var e;let[t,n]=(0,R.useState)(""),[D,E]=(0,R.useState)("001"),[B,z]=(0,R.useState)(null),[G,O]=(0,R.useState)(!1),[U,A]=(0,R.useState)(!1),[L,F]=(0,R.useState)("new"),[N,W]=(0,R.useState)("new"),[_,H]=(0,R.useState)(null),M=(0,R.useRef)(null),V=(0,R.useRef)(null),J=(0,R.useRef)(null),q=(0,R.useRef)(null),K=(0,R.useRef)(null),Q=(0,R.useRef)([]),X=(0,R.useRef)(null);(0,R.useEffect)(()=>{X.current=B},[B]),(0,R.useEffect)(()=>{if(!G||!V.current)return;let e=setInterval(()=>{let e=V.current;if(e){let t=e.connectionState,n=e.iceConnectionState;t!==L&&F(t),n!==N&&W(n);let r="connected"===t&&("connected"===n||"completed"===n);r!==U&&A(r)}},2e3);return()=>clearInterval(e)},[G,L,N,U]);let Y=e=>{let t=new URL(window.location.href);e!==t.searchParams.get("id")&&(t.searchParams.set("id",e),window.history.replaceState({},"",t.href))},Z=G?"已".concat(B?"".concat("creator"===B?"创建":"加入"):""):"未连接",$=G?"green":"gray",ee=U?"P2P已连接":"P2P未连接",et=U?"green":"connecting"===L?"yellow":"gray",en=async e=>{if(e)try{await e.play()}catch(e){console.info("视频播放失败",e)}},er=async(e,t)=>{K.current=t,J.current&&(J.current.srcObject=t,await en(J.current)),t.getTracks().forEach(n=>e.addTrack(n,t))},ea=async()=>{try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:{width:640,height:360}})}catch(e){console.info("获取视频失败",e),C.notifications.show({message:"请检查摄像头权限",color:"orange"});try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(e){console.info("获取音频失败",e),C.notifications.show({message:"请检查麦克风权限",color:"orange"})}}},ei=async e=>{if(Q.current.length)for(let t of Q.current.splice(0))try{await e.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.info("添加 ICE 候选失败",e)}},ec=async(e,t)=>{await e.setRemoteDescription(new RTCSessionDescription(t)),await ei(e)},eo=async(e,t)=>{try{e.remoteDescription?await e.addIceCandidate(new RTCIceCandidate(t)):Q.current.push(t)}catch(e){console.info("添加 ICE 候选失败",e)}},es=async e=>{try{await fetch("".concat(c.FH.getUri(),"/api.signaling"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.info("发送信号失败",e)}},el=async()=>{try{let e=await c.FH.get("/api.room",{params:{roomId:D}});if(e.data.ok)return e.data.users}catch(e){console.info("获取房间用户失败",e)}},ed=async()=>{let e=V.current;if(e)try{let t=await e.getStats(),n={};t.forEach(e=>{"candidate-pair"===e.type&&"succeeded"===e.state&&(n.candidatePair={bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,currentRoundTripTime:e.currentRoundTripTime,availableOutgoingBitrate:e.availableOutgoingBitrate}),"inbound-rtp"===e.type&&"video"===e.mediaType&&(n.inboundVideo={bytesReceived:e.bytesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,framesDecoded:e.framesDecoded}),"outbound-rtp"===e.type&&"video"===e.mediaType&&(n.outboundVideo={bytesSent:e.bytesSent,packetsSent:e.packetsSent,framesEncoded:e.framesEncoded})}),H(n),console.log("连接统计信息:",n)}catch(e){console.error("获取连接统计失败:",e)}},eu=async()=>{let e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.nextcloud.com:443"},{urls:"stun:stun.freeswitch.org:3478"}]});e.oniceconnectionstatechange=()=>{let t=e.iceConnectionState;W(t),console.log("ICE 连接状态变化:",t),"connected"===t||"completed"===t?(A(!0),C.notifications.show({message:"P2P 连接已建立！",color:"green"})):("disconnected"===t||"failed"===t)&&(A(!1),"failed"===t&&C.notifications.show({message:"P2P 连接失败，请重试",color:"red"}))},e.onconnectionstatechange=()=>{let t=e.connectionState;F(t),console.log("连接状态变化:",t),"connected"===t?(A(!0),C.notifications.show({message:"WebRTC 连接已建立！",color:"green"})):"disconnected"===t||"failed"===t?(A(!1),"failed"===t&&C.notifications.show({message:"WebRTC 连接失败",color:"red"})):"connecting"===t&&C.notifications.show({message:"正在建立 P2P 连接...",color:"blue"})},e.onicecandidate=e=>{e.candidate&&es({roomId:D,from:t,type:"candidate",payload:e.candidate})},e.ontrack=e=>{if(!q.current)return;let[t]=e.streams;t&&(q.current.srcObject=t,en(q.current))};let n=await ea();return n&&await er(e,n),V.current=e,e},eh=async()=>{try{let e=await el();if(!e)return void C.notifications.show({message:"获取房间用户失败",color:"red"});if(e.length>=2)return void C.notifications.show({message:"房间已满，试试更换房间 ID",color:"red"});let n=0===e.length?"creator":"joiner";X.current=n,Q.current=[],await eu(),z(n),M.current&&M.current.close();let r=new URL(c.FH.getUri());r.pathname="/sse.signaling",r.searchParams.append("roomId",D),r.searchParams.append("clientId",t);let a=new EventSource(r.href,{withCredentials:!1});if(a.onopen=()=>{var e;O(!0);let n=V.current;"joiner"===X.current&&(null==n||null==(e=n.localDescription)?void 0:e.type)==="offer"&&es({roomId:D,from:t,type:"offer",payload:n.localDescription})},a.onerror=e=>{console.info("SSE 连接错误",e)},a.onmessage=async e=>{try{let n=JSON.parse(e.data);if(!n||!n.type||"hello"===n.type)return;if("join"===n.type)return void C.notifications.show({message:n.clientId+" 加入房间",color:"blue"});if("leave"===n.type){C.notifications.show({message:n.clientId+" 离开房间",color:"blue"}),"joiner"===X.current&&ep();return}let r=V.current;if(!r)return;if("offer"===n.type&&"creator"===X.current){await ec(r,n.payload);let e=await r.createAnswer();await r.setLocalDescription(e),await es({roomId:D,from:t,type:"answer",payload:e})}else"answer"===n.type&&"joiner"===X.current?await ec(r,n.payload):"candidate"===n.type&&await eo(r,n.payload)}catch(e){console.info(e)}},M.current=a,"joiner"===n){let e=V.current,n=await e.createOffer();await e.setLocalDescription(n),await es({roomId:D,from:t,type:"offer",payload:n})}}catch(e){console.info("连接失败",e)}},ep=async()=>{var e,t;null==(e=M.current)||e.close(),M.current=null,O(!1),z(null),A(!1),F("new"),W("new"),H(null);let n=V.current;n&&(n.getSenders().forEach(e=>{try{var t;null==(t=e.track)||t.stop()}catch(e){console.info("停止发送器失败",e)}}),n.onicecandidate=null,n.ontrack=null,n.close(),V.current=null),null==(t=K.current)||t.getTracks().forEach(e=>e.stop()),K.current=null,Q.current=[]},ef=(0,I.B)(),eg=(0,R.useRef)(null),em=(0,k.k)(e=>e.nodeDark),ey=async()=>{eg.current&&(await ef.initViewer(eg.current)).setMarkdown(P.A)};return(0,R.useEffect)(()=>{n(Math.random().toString(36).slice(2,10).toUpperCase());let e=new URLSearchParams(window.location.search).get("id");return E(e||D),Y(e||D),ey(),()=>{ep()}},[]),(0,r.jsxs)(o.Container,{py:"md",children:[(0,r.jsx)(a.AppHeader,{title:"点对点聊天"}),(0,r.jsxs)(s.Stack,{gap:"md",children:[(0,r.jsx)(l.Center,{children:(0,r.jsx)(i.I,{name:"Chat",size:40})}),(0,r.jsxs)(d.Group,{justify:"space-between",align:"center",children:[(0,r.jsx)(u.Title,{size:"h2",children:"WebRTC + HTTP + SSE"}),(0,r.jsxs)(d.Group,{gap:"sm",children:[(0,r.jsx)(h.Badge,{size:"lg",color:$,variant:"light","aria-live":"polite","aria-atomic":!0,children:Z}),G&&(0,r.jsx)(h.Badge,{size:"lg",color:et,variant:"light","aria-label":"P2P 连接状态",children:ee})]})]}),(0,r.jsx)(p.Paper,{p:"md",withBorder:!0,radius:"md",children:(0,r.jsxs)(d.Group,{align:"flex-end",wrap:"wrap",justify:"space-between",children:[(0,r.jsx)(f.TextInput,{label:"房间 ID",description:"使用相同的房间 ID 才可建立连接",value:D,onChange:e=>{Y(e.currentTarget.value),E(e.currentTarget.value)},placeholder:"输入房间 ID",flex:1,miw:280,rightSection:(0,r.jsx)(g.CopyButton,{value:D,timeout:1e3,children:e=>{let{copied:t,copy:n}=e;return(0,r.jsx)(m.Tooltip,{label:t?"已复制":"复制",children:(0,r.jsx)(y.ActionIcon,{variant:t?"filled":"light",color:t?"teal":"gray",onClick:n,"aria-label":"复制房间ID",children:t?"✓":"⧉"})})}})}),(0,r.jsx)(d.Group,{gap:"xs",wrap:"wrap",children:G?(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(w.Button,{color:"red",variant:"light",onClick:ep,leftSection:(0,r.jsx)(S.A,{size:16}),children:"断开"})}):(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(w.Button,{onClick:()=>eh(),disabled:!t,leftSection:(0,r.jsx)(T.A,{size:16}),color:"blue",variant:"light",children:"加入"})})})]})}),G&&(0,r.jsxs)(p.Paper,{p:"md",withBorder:!0,radius:"md",children:[(0,r.jsxs)(d.Group,{justify:"space-between",align:"center",mb:"sm",children:[(0,r.jsx)(x.Text,{fw:500,children:"连接状态详情"}),(0,r.jsx)(h.Badge,{variant:"light",color:et,children:U?"已连接":"未连接"})]}),(0,r.jsxs)(j.SimpleGrid,{cols:{base:1,sm:2},spacing:"sm",children:[(0,r.jsxs)(d.Group,{justify:"space-between",p:"xs",style:{backgroundColor:"var(--mantine-color-gray-light)",borderRadius:4},children:[(0,r.jsx)(x.Text,{size:"sm",children:"WebRTC 连接状态:"}),(0,r.jsx)(h.Badge,{size:"sm",color:"connected"===L?"green":"connecting"===L?"yellow":"gray",children:L})]}),(0,r.jsxs)(d.Group,{justify:"space-between",p:"xs",style:{backgroundColor:"var(--mantine-color-gray-light)",borderRadius:4},children:[(0,r.jsx)(x.Text,{size:"sm",children:"ICE 连接状态:"}),(0,r.jsx)(h.Badge,{size:"sm",color:"connected"===N||"completed"===N?"green":"checking"===N?"yellow":"gray",children:N})]})]}),!U&&G&&(0,r.jsx)(x.Text,{size:"sm",c:"dimmed",mt:"sm",children:"\uD83D\uDCA1 提示: 如果长时间无法建立 P2P 连接，请检查网络 IPv6 配置或尝试重新连接"}),U&&(0,r.jsxs)(d.Group,{mt:"sm",gap:"xs",children:[(0,r.jsx)(w.Button,{size:"xs",variant:"light",color:"blue",onClick:ed,children:"延迟"}),_&&(0,r.jsxs)(x.Text,{size:"xs",c:"dimmed",children:["RTT:"," ",(null==(e=_.candidatePair)?void 0:e.currentRoundTripTime)?"".concat((1e3*_.candidatePair.currentRoundTripTime).toFixed(0),"ms"):"失败"]})]})]}),(0,r.jsxs)(j.SimpleGrid,{cols:{base:1,sm:2},spacing:"md",children:[(0,r.jsxs)(p.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,r.jsx)(l.Center,{children:(0,r.jsx)(x.Text,{children:"本地"})}),(0,r.jsx)("video",{ref:J,playsInline:!0,autoPlay:!0,muted:!0,"aria-label":"本地媒体流视频",title:"本地媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}})]}),(0,r.jsxs)(p.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,r.jsx)(l.Center,{children:(0,r.jsx)(x.Text,{children:"远端"})}),(0,r.jsx)("video",{ref:q,playsInline:!0,autoPlay:!0,"aria-label":"远端媒体流视频",title:"远端媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}})]})]}),(0,r.jsx)(b.Card,{withBorder:!0,children:(0,r.jsx)(v.Box,{className:em,ref:eg})})]})]})}}},e=>{e.O(0,[8198,2545,642,4771,8805,8413,6634,3722,3464,2996,4726,7361,6986,630,3003,8441,5964,7358],()=>e(e.s=16542)),_N_E=e.O()}]);