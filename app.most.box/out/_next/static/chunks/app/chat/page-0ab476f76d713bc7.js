(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8457],{4673:(e,t,r)=>{"use strict";r.d(t,{BP:()=>f,OM:()=>m,yO:()=>h});var n=r(30167),a=r(71425),o=r(44532),i=r(87788),s=r(56076),l=r(88413),c=r(70358),d=r(26634),u=r.n(d);let f=(e,t,r)=>{let c=(0,n.YW)(t),d=(0,n.YW)("/most.box/"+e),f=(0,a.A)(c,d,3,32,"sha512"),h=(0,o.q5)((0,i.s)(f)),m=h.slice(0,32),p=u().box.keyPair.fromSecretKey(m),g=(0,o.c$)(p.publicKey),y=(0,o.c$)(p.secretKey),w=s.v.entropyToPhrase(h);return{username:e,address:l.QX.fromPhrase(w).address,public_key:g,private_key:y,mnemonic:"I know loss mnemonic will lose my wallet."===r?w:""}},h=(e,t,r)=>{let n=new TextEncoder().encode(e),a=u().randomBytes(u().box.nonceLength),i=u().box(n,a,new Uint8Array((0,o.q5)(t)),new Uint8Array((0,o.q5)(r)));return i?["mp://2",(0,c.W)(a),(0,c.W)(i)].join("."):(console.info("加密失败"),"")},m=(e,t,r)=>{let[n,a,i]=e.split(".");if("mp://2"!==n)return console.info("无效协议"),"";let s=u().box.open((0,c.y)(i),(0,c.y)(a),new Uint8Array((0,o.q5)(t)),new Uint8Array((0,o.q5)(r)));return s?new TextDecoder().decode(s):(console.info("解密失败"),"")}},9482:(e,t,r)=>{"use strict";r.d(t,{A:()=>b});var n=r(70358),a=r(30167),o=r(88413),i=r(19396),s=r(96842),l=r(42995),c=r(3648),d=r(4673),u=r(59909),f=r(30832),h=r.n(f),m=r(99758),p=r.n(m);r(38464);var g=r(76920),y=r.n(g);h().extend(y()),h().extend(p()),h().locale("zh-cn");let w=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YYMMDD",r=h()().format(t),n=sessionStorage.getItem("fingerprint");if(!n)throw Error("请先获取设备指纹");let a=[location.origin,n].join("/"),{public_key:o,private_key:i}=(0,d.BP)(r,a);return(0,d.yO)(JSON.stringify(e),o,i)},x=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YYMMDD",r=h()().format(t),n=sessionStorage.getItem("fingerprint");if(!n)throw Error("请先获取设备指纹");let a=[location.origin,n].join("/"),{public_key:o,private_key:i}=(0,d.BP)(r,a),s=(0,d.OM)(e,o,i);if(s)try{let e=JSON.parse(s);if(e.address)return e}catch(e){console.error(e)}return console.log("jwt 过期"),null},j=async e=>{let t=Date.now().toString(),r=o.QX.fromPhrase(e.mnemonic),n=await r.signMessage(t);localStorage.token=[e.address,t,n].join(".")},v=e=>{try{var t;let r=w(e);if((null==(t=x(r))?void 0:t.address)===e.address)return localStorage.setItem("jwt",r),j(e),e}catch(e){console.log("登录失败:",e)}return null},b={avatar:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Most";return(0,s.gn)(l,{seed:"most.box@"+e,flip:!0,backgroundType:["gradientLinear"]}).toDataUri()},avatarCID:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Most";return(0,s.gn)(c,{seed:"most.box#"+e,flip:!0,backgroundType:["gradientLinear","solid"]}).toDataUri()},formatTime:e=>{let t;if(!e)return"";let r=h()(Number(e)),n=r.hour();return t=n>=0&&n<3?"凌晨":n>=3&&n<6?"拂晓":n>=6&&n<9?"早晨":n>=9&&n<12?"上午":n>=12&&n<15?"下午":n>=15&&n<18?"傍晚":n>=18&&n<21?"薄暮":"深夜",r.format("YYYY年M月D日 ".concat(t,"h点m分"))},formatDate:e=>{let t=h()(Number(e)),r=h()();return t.isSame(r,"day")?t.format("HH:mm"):t.isSame(r.subtract(1,"day"),"day")?"昨天 ".concat(t.format("HH:mm")):t.isoWeek()===r.isoWeek()?"".concat(["周日","周一","周二","周三","周四","周五","周六"][t.day()]," ").concat(t.format("HH:mm")):t.year()===r.year()?t.format("M月D日"):t.format("YY年M月D日")},formatAddress:e=>e?e.slice(0,6)+"..."+e.slice(-4):"",enBase64:e=>(0,n.W)((0,a.YW)(e)),deBase64:e=>(0,a._v)((0,n.y)(e)),createJWT:w,verifyJWT:x,login:(e,t)=>v((0,d.BP)(e,t,"I know loss mnemonic will lose my wallet.")),loginSave:v,ZeroAddress:i.j,createToken:j,pinyin:function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;if(t.length<r)return!1;if(e.toLowerCase().includes(t.toLowerCase()))return!0;let n=(0,u.YW)(e,t,{continuous:!0});return!!n&&!!(n.length>=r)}}},13422:(e,t,r)=>{Promise.resolve().then(r.bind(r,42047))},42047:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>k});var n=r(95155),a=r(80630),o=r(22450),i=r(48764),s=r(91590),l=r(21220),c=r(8141),d=r(70112),u=r(93751),f=r(26029),h=r(97287),m=r(8593),p=r(42445),g=r(27361),y=r(81001),w=r(26903),x=r(58887),j=r(18229),v=r(6942),b=r(38232),I=r(64077),S=r(34311),C=r(59063),D=r(12115);function k(){let e=(0,i.k)(e=>e.dotAPI),[t,r]=(0,D.useState)("001"),[k,P]=(0,D.useState)(""),[T,A]=(0,D.useState)(null),[R,B]=(0,D.useState)(!1),[U,E]=(0,D.useState)([]),L=k.length>0,M=(0,D.useRef)(null),W=(0,D.useRef)(null),O=(0,D.useRef)(null),Y=(0,D.useRef)(null),z=(0,D.useRef)(null),H=(0,D.useRef)([]),N=(0,D.useRef)(null);(0,D.useEffect)(()=>{N.current=T},[T]);let G=e=>{let t=new URL(window.location.href);t.searchParams.set("id",e),window.history.replaceState({},"",t.href)},_=R?"已连接".concat(T?"（".concat("creator"===T?"创建者":"加入者","）"):""):"未连接",q=R?"green":"gray",F=async e=>{if(e)try{await e.play()}catch(e){console.info("视频播放失败",e)}},J=async(e,t)=>{z.current=t,O.current&&(O.current.srcObject=t,await F(O.current)),t.getTracks().forEach(r=>e.addTrack(r,t))},K=async()=>{try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:{width:640,height:360}})}catch(e){console.info("获取视频失败",e),v.notifications.show({message:"请检查摄像头权限",color:"orange"});try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(e){console.info("获取音频失败",e),v.notifications.show({message:"请检查麦克风权限",color:"orange"})}}},Q=async e=>{if(H.current.length)for(let t of H.current.splice(0))try{await e.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.info("添加 ICE 候选失败",e)}},X=async(e,t)=>{await e.setRemoteDescription(new RTCSessionDescription(t)),await Q(e)},$=async(e,t)=>{try{e.remoteDescription?await e.addIceCandidate(new RTCIceCandidate(t)):H.current.push(t)}catch(e){console.info("添加 ICE 候选失败",e)}},Z=async t=>{try{await fetch("".concat(e,"/api.signaling"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(e){console.info("发送信号失败",e)}},V=async()=>{try{let r=await fetch("".concat(e,"/api.room?roomId=").concat(encodeURIComponent(t))),n=await r.json();n.ok&&E(n.users||[])}catch(e){console.info("获取房间用户失败",e)}},ee=async()=>{let e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.nextcloud.com:443"},{urls:"stun:stun.freeswitch.org:3478"}]});e.oniceconnectionstatechange=()=>{},e.onconnectionstatechange=()=>{},e.onicecandidate=e=>{e.candidate&&Z({roomId:t,from:k,type:"candidate",payload:e.candidate})},e.ontrack=e=>{if(!Y.current)return;let[t]=e.streams;t&&(Y.current.srcObject=t,F(Y.current))};let r=await K();return r&&await J(e,r),W.current=e,e},et=async r=>{try{N.current=r,H.current=[],await ee(),A(r),M.current&&M.current.close();let n=new URL(e);n.pathname="/sse.signaling",n.searchParams.append("roomId",t),n.searchParams.append("clientId",k);let a=new EventSource(n.href,{withCredentials:!1});if(a.onopen=()=>{var e;B(!0),V(),a.userListInterval=setInterval(V,5e3);let r=W.current;"joiner"===N.current&&(null==r||null==(e=r.localDescription)?void 0:e.type)==="offer"&&Z({roomId:t,from:k,type:"offer",payload:r.localDescription})},a.onerror=e=>{console.info("SSE 连接错误",e)},a.onmessage=async e=>{try{let r=JSON.parse(e.data);if(!r||!r.type||"hello"===r.type)return;let n=W.current;if(!n)return;if("offer"===r.type&&"creator"===N.current){await X(n,r.payload);let e=await n.createAnswer();await n.setLocalDescription(e),await Z({roomId:t,from:k,type:"answer",payload:e})}else"answer"===r.type&&"joiner"===N.current?await X(n,r.payload):"candidate"===r.type&&await $(n,r.payload)}catch(e){console.info(e)}},M.current=a,"joiner"===r){let e=W.current,r=await e.createOffer();await e.setLocalDescription(r),await Z({roomId:t,from:k,type:"offer",payload:r})}}catch(e){console.info("连接失败",e)}},er=()=>{var e,t;M.current&&M.current.userListInterval&&clearInterval(M.current.userListInterval),null==(e=M.current)||e.close(),M.current=null,B(!1),A(null),E([]);let r=W.current;r&&(r.getSenders().forEach(e=>{try{var t;null==(t=e.track)||t.stop()}catch(e){console.info("停止发送器失败",e)}}),r.onicecandidate=null,r.ontrack=null,r.close(),W.current=null),null==(t=z.current)||t.getTracks().forEach(e=>e.stop()),z.current=null,H.current=[]};return(0,D.useEffect)(()=>()=>{er()},[]),(0,D.useEffect)(()=>{G(t),P("undefined"!=typeof crypto&&"randomUUID"in crypto?crypto.randomUUID():String(Math.random()).slice(2))},[]),(0,n.jsxs)(s.Container,{py:"md",children:[(0,n.jsx)(a.AppHeader,{title:"点对点聊天"}),(0,n.jsxs)(l.Stack,{gap:"md",children:[(0,n.jsx)(c.Center,{children:(0,n.jsx)(o.I,{name:"Chat",size:40})}),(0,n.jsxs)(d.Group,{justify:"space-between",align:"center",children:[(0,n.jsx)(u.Title,{size:"h2",children:"WebRTC + HTTP + SSE"}),(0,n.jsxs)(d.Group,{gap:"sm",children:[(0,n.jsx)(f.Badge,{size:"lg",color:q,variant:"light","aria-live":"polite","aria-atomic":!0,children:_}),R&&(0,n.jsxs)(f.Badge,{size:"lg",color:"blue",variant:"light","aria-label":"房间用户数量",children:[U.length," 人在线"]})]})]}),(0,n.jsx)(h.Paper,{p:"md",withBorder:!0,radius:"md",children:(0,n.jsxs)(d.Group,{align:"flex-end",wrap:"wrap",justify:"space-between",children:[(0,n.jsx)(m.TextInput,{label:"房间 ID",description:"使用相同的房间 ID 才可建立连接",value:t,onChange:e=>{G(e.currentTarget.value),r(e.currentTarget.value)},placeholder:"输入房间 ID",flex:1,miw:280,rightSection:(0,n.jsx)(p.CopyButton,{value:t,timeout:1e3,children:e=>{let{copied:t,copy:r}=e;return(0,n.jsx)(g.Tooltip,{label:t?"已复制":"复制",children:(0,n.jsx)(y.ActionIcon,{variant:t?"filled":"light",color:t?"teal":"gray",onClick:r,"aria-label":"复制房间ID",children:t?"✓":"⧉"})})}})}),(0,n.jsx)(d.Group,{gap:"xs",wrap:"wrap",children:R?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(w.Button,{color:"red",variant:"light",onClick:er,leftSection:(0,n.jsx)(b.A,{size:16}),children:"断开"}),"joiner"===T&&(0,n.jsx)(w.Button,{variant:"light",color:"blue",onClick:()=>{var e;let r=W.current;(null==r||null==(e=r.localDescription)?void 0:e.type)==="offer"&&Z({roomId:t,from:k,type:"offer",payload:r.localDescription})},leftSection:(0,n.jsx)(I.A,{size:16}),children:"重试"})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(w.Button,{onClick:()=>et("creator"),disabled:!L||R,leftSection:(0,n.jsx)(S.A,{size:16}),color:"orange",variant:"light",children:"创建"}),(0,n.jsx)(w.Button,{onClick:()=>et("joiner"),disabled:!L||R,leftSection:(0,n.jsx)(C.A,{size:16}),color:"blue",variant:"light",children:"加入"})]})})]})}),R&&U.length>0&&(0,n.jsxs)(h.Paper,{p:"md",withBorder:!0,radius:"md",children:[(0,n.jsxs)(d.Group,{justify:"space-between",align:"center",mb:"sm",children:[(0,n.jsx)(x.Text,{fw:500,children:"房间用户列表"}),(0,n.jsxs)(f.Badge,{variant:"light",color:"blue",children:[U.length," 人"]})]}),(0,n.jsx)(l.Stack,{gap:"xs",children:U.map(e=>(0,n.jsxs)(d.Group,{justify:"space-between",p:"xs",style:{backgroundColor:e===k?"var(--mantine-color-blue-light)":"var(--mantine-color-gray-light)",borderRadius:4},children:[(0,n.jsx)(x.Text,{size:"sm",ff:"monospace",children:e===k?"".concat(e," (我)"):e}),e===k&&(0,n.jsx)(f.Badge,{size:"xs",color:"blue",variant:"filled",children:"我"})]},e))})]}),(0,n.jsxs)(j.SimpleGrid,{cols:{base:1,sm:2},spacing:"md",children:[(0,n.jsxs)(h.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,n.jsx)(c.Center,{children:(0,n.jsx)(x.Text,{children:"我"})}),(0,n.jsx)("video",{ref:O,playsInline:!0,autoPlay:!0,muted:!0,"aria-label":"本地媒体流视频",title:"本地媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}})]}),(0,n.jsxs)(h.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,n.jsx)(c.Center,{children:(0,n.jsx)(x.Text,{children:"你"})}),(0,n.jsx)("video",{ref:Y,playsInline:!0,autoPlay:!0,"aria-label":"远端媒体流视频",title:"远端媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}})]})]})]})]})}},48764:(e,t,r)=>{"use strict";r.d(t,{k:()=>s});var n=r(9482),a=r(65453),o=r(54205),i=r(6942);let s=(0,a.v)((e,t)=>({wallet:void 0,initWallet(r){e({fingerprint:r});let a=localStorage.getItem("jwt");if(a){let r=n.A.verifyJWT(a);r?(n.A.createToken(r),e({wallet:r})):t().exit()}},async updateDot(t){try{let r=new URL(t).origin,n=(await o.FH.get("/api.dot",{baseURL:r})).data;o.FH.defaults.baseURL=r,e({dotAPI:r}),localStorage.setItem("dotAPI",r);let a=n.CIDs[0];return r.endsWith(":1976")&&(a=r.slice(0,-5)+":8080"),a&&(e({dotCID:a}),localStorage.setItem("dotCID",a)),e({notes:void 0,files:void 0}),n.APIs}catch(r){i.notifications.show({title:"节点不可用",message:t||r.message,color:"red"}),console.info(r),e({dotAPI:o.FH.defaults.baseURL||""})}return null},setItem:(t,r)=>e(e=>({...e,[t]:r})),firstPath:"",dotAPI:"",dotCID:"",dotNodes:[],notes:void 0,notesQuery:"",nodeDark:"",files:void 0,filesPath:"",fingerprint:"",exit(){e({wallet:void 0,notes:void 0,files:void 0}),localStorage.removeItem("jwt"),localStorage.removeItem("token")}}))},54205:(e,t,r)=>{"use strict";r.d(t,{C2:()=>a,FH:()=>o});var n=r(23464);let a="https://most.box/auth/callback",o=n.A.create({baseURL:""});o.interceptors.request.use(e=>{let t=localStorage.getItem("token");return t&&(e.headers.Authorization=t),e},e=>Promise.reject(e)),o.interceptors.response.use(e=>e,e=>Promise.reject(e))},71281:()=>{}},e=>{e.O(0,[8198,2545,4771,8805,8413,6634,3722,3464,2996,4726,7361,4204,630,8441,5964,7358],()=>e(e.s=13422)),_N_E=e.O()}]);