(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8457],{13422:(e,t,r)=>{Promise.resolve().then(r.bind(r,80262))},80262:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>D});var n=r(95155),a=r(90101),i=r(13947),c=r(21794),o=r(13877),s=r(2369),l=r(40387),d=r(67661),u=r(74264),h=r(17998),p=r(82726),f=r(60688),g=r(93852),m=r(9457),y=r(58380),w=r(96778),x=r(70305),j=r(21179),b=r(44634),v=r(67623),C=r(59126),S=r(93027),T=r(64998),R=r(12115),P=r(38639),k=r(13297),I=r(61505);function D(){var e;let[t,r]=(0,R.useState)(""),[D,E]=(0,R.useState)("001"),[B,z]=(0,R.useState)(null),[G,O]=(0,R.useState)(!1),[U,A]=(0,R.useState)(!1),[L,F]=(0,R.useState)("new"),[N,W]=(0,R.useState)("new"),[_,H]=(0,R.useState)(null),M=(0,R.useRef)(null),V=(0,R.useRef)(null),J=(0,R.useRef)(null),q=(0,R.useRef)(null),K=(0,R.useRef)(null),Q=(0,R.useRef)([]),X=(0,R.useRef)(null);(0,R.useEffect)(()=>{X.current=B},[B]),(0,R.useEffect)(()=>{if(!G||!V.current)return;let e=setInterval(()=>{let e=V.current;if(e){let t=e.connectionState,r=e.iceConnectionState;t!==L&&F(t),r!==N&&W(r);let n="connected"===t&&("connected"===r||"completed"===r);n!==U&&A(n)}},2e3);return()=>clearInterval(e)},[G,L,N,U]);let Y=e=>{let t=new URL(window.location.href);e!==t.searchParams.get("id")&&(t.searchParams.set("id",e),window.history.replaceState({},"",t.href))},Z=G?"已".concat(B?"".concat("creator"===B?"创建":"加入"):""):"未连接",$=G?"green":"gray",ee=U?"P2P已连接":"P2P未连接",et=U?"green":"connecting"===L?"yellow":"gray",er=async e=>{if(e)try{await e.play()}catch(e){console.info("视频播放失败",e)}},en=async(e,t)=>{K.current=t,J.current&&(J.current.srcObject=t,await er(J.current)),t.getTracks().forEach(r=>e.addTrack(r,t))},ea=async()=>{try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:{width:640,height:360}})}catch(e){console.info("获取视频失败",e),C.notifications.show({message:"请检查摄像头权限",color:"orange"});try{return await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(e){console.info("获取音频失败",e),C.notifications.show({message:"请检查麦克风权限",color:"orange"})}}},ei=async e=>{if(Q.current.length)for(let t of Q.current.splice(0))try{await e.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.info("添加 ICE 候选失败",e)}},ec=async(e,t)=>{await e.setRemoteDescription(new RTCSessionDescription(t)),await ei(e)},eo=async(e,t)=>{try{e.remoteDescription?await e.addIceCandidate(new RTCIceCandidate(t)):Q.current.push(t)}catch(e){console.info("添加 ICE 候选失败",e)}},es=async e=>{try{await fetch("".concat(c.FH.getUri(),"/api.signaling"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.info("发送信号失败",e)}},el=async()=>{try{let e=await c.FH.get("/api.room",{params:{roomId:D}});if(e.data.ok)return e.data.users}catch(e){console.info("获取房间用户失败",e)}},ed=async()=>{let e=V.current;if(e)try{let t=await e.getStats(),r={};t.forEach(e=>{"candidate-pair"===e.type&&"succeeded"===e.state&&(r.candidatePair={bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,currentRoundTripTime:e.currentRoundTripTime,availableOutgoingBitrate:e.availableOutgoingBitrate}),"inbound-rtp"===e.type&&"video"===e.mediaType&&(r.inboundVideo={bytesReceived:e.bytesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,framesDecoded:e.framesDecoded}),"outbound-rtp"===e.type&&"video"===e.mediaType&&(r.outboundVideo={bytesSent:e.bytesSent,packetsSent:e.packetsSent,framesEncoded:e.framesEncoded})}),H(r),console.log("连接统计信息:",r)}catch(e){console.error("获取连接统计失败:",e)}},eu=async()=>{let e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.nextcloud.com:443"},{urls:"stun:stun.freeswitch.org:3478"}]});e.oniceconnectionstatechange=()=>{let t=e.iceConnectionState;W(t),console.log("ICE 连接状态变化:",t),"connected"===t||"completed"===t?(A(!0),C.notifications.show({message:"P2P 连接已建立！",color:"green"})):("disconnected"===t||"failed"===t)&&(A(!1),"failed"===t&&C.notifications.show({message:"P2P 连接失败，请重试",color:"red"}))},e.onconnectionstatechange=()=>{let t=e.connectionState;F(t),console.log("连接状态变化:",t),"connected"===t?(A(!0),C.notifications.show({message:"WebRTC 连接已建立！",color:"green"})):"disconnected"===t||"failed"===t?(A(!1),"failed"===t&&C.notifications.show({message:"WebRTC 连接失败",color:"red"})):"connecting"===t&&C.notifications.show({message:"正在建立 P2P 连接...",color:"blue"})},e.onicecandidate=e=>{e.candidate&&es({roomId:D,from:t,type:"candidate",payload:e.candidate})},e.ontrack=e=>{if(!q.current)return;let[t]=e.streams;t&&(q.current.srcObject=t,er(q.current))};let r=await ea();return r&&await en(e,r),V.current=e,e},eh=async()=>{try{let e=await el();if(!e)return void C.notifications.show({message:"获取房间用户失败",color:"red"});if(e.length>=2)return void C.notifications.show({message:"房间已满，试试更换房间 ID",color:"red"});let r=0===e.length?"creator":"joiner";X.current=r,Q.current=[],await eu(),z(r),M.current&&M.current.close();let n=new URL(c.FH.getUri());n.pathname="/sse.signaling",n.searchParams.append("roomId",D),n.searchParams.append("clientId",t);let a=new EventSource(n.href,{withCredentials:!1});if(a.onopen=()=>{var e;O(!0);let r=V.current;"joiner"===X.current&&(null==r||null==(e=r.localDescription)?void 0:e.type)==="offer"&&es({roomId:D,from:t,type:"offer",payload:r.localDescription})},a.onerror=e=>{console.info("SSE 连接错误",e)},a.onmessage=async e=>{try{let r=JSON.parse(e.data);if(!r||!r.type||"hello"===r.type)return;if("join"===r.type)return void C.notifications.show({message:r.clientId+" 加入房间",color:"blue"});if("leave"===r.type){C.notifications.show({message:r.clientId+" 离开房间",color:"blue"}),"joiner"===X.current&&ep();return}let n=V.current;if(!n)return;if("offer"===r.type&&"creator"===X.current){await ec(n,r.payload);let e=await n.createAnswer();await n.setLocalDescription(e),await es({roomId:D,from:t,type:"answer",payload:e})}else"answer"===r.type&&"joiner"===X.current?await ec(n,r.payload):"candidate"===r.type&&await eo(n,r.payload)}catch(e){console.info(e)}},M.current=a,"joiner"===r){let e=V.current,r=await e.createOffer();await e.setLocalDescription(r),await es({roomId:D,from:t,type:"offer",payload:r})}}catch(e){console.info("连接失败",e)}},ep=async()=>{var e,t;null==(e=M.current)||e.close(),M.current=null,O(!1),z(null),A(!1),F("new"),W("new"),H(null);let r=V.current;r&&(r.getSenders().forEach(e=>{try{var t;null==(t=e.track)||t.stop()}catch(e){console.info("停止发送器失败",e)}}),r.onicecandidate=null,r.ontrack=null,r.close(),V.current=null),null==(t=K.current)||t.getTracks().forEach(e=>e.stop()),K.current=null,Q.current=[]},ef=(0,I.B)(),eg=(0,R.useRef)(null),em=(0,k.k)(e=>e.nodeDark),ey=async()=>{eg.current&&(await ef.initViewer(eg.current)).setMarkdown(P.A)};return(0,R.useEffect)(()=>{r(Math.random().toString(36).slice(2,10).toUpperCase());let e=new URLSearchParams(window.location.search).get("id");return E(e||D),Y(e||D),ey(),()=>{ep()}},[]),(0,n.jsxs)(o.Container,{py:"md",children:[(0,n.jsx)(a.AppHeader,{title:"点对点聊天"}),(0,n.jsxs)(s.Stack,{gap:"md",children:[(0,n.jsx)(l.Center,{children:(0,n.jsx)(i.I,{name:"Chat",size:40})}),(0,n.jsxs)(d.Group,{justify:"space-between",align:"center",children:[(0,n.jsx)(u.Title,{size:"h2",children:"WebRTC + HTTP + SSE"}),(0,n.jsxs)(d.Group,{gap:"sm",children:[(0,n.jsx)(h.Badge,{size:"lg",color:$,variant:"light","aria-live":"polite","aria-atomic":!0,children:Z}),G&&(0,n.jsx)(h.Badge,{size:"lg",color:et,variant:"light","aria-label":"P2P 连接状态",children:ee})]})]}),(0,n.jsx)(p.Paper,{p:"md",withBorder:!0,radius:"md",children:(0,n.jsxs)(d.Group,{align:"flex-end",wrap:"wrap",justify:"space-between",children:[(0,n.jsx)(f.TextInput,{label:"房间 ID",description:"使用相同的房间 ID 才可建立连接",value:D,onChange:e=>{Y(e.currentTarget.value),E(e.currentTarget.value)},placeholder:"输入房间 ID",flex:1,miw:280,rightSection:(0,n.jsx)(g.CopyButton,{value:D,timeout:1e3,children:e=>{let{copied:t,copy:r}=e;return(0,n.jsx)(m.Tooltip,{label:t?"已复制":"复制",children:(0,n.jsx)(y.ActionIcon,{variant:t?"filled":"light",color:t?"teal":"gray",onClick:r,"aria-label":"复制房间ID",children:t?"✓":"⧉"})})}})}),(0,n.jsx)(d.Group,{gap:"xs",wrap:"wrap",children:G?(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(w.Button,{color:"red",variant:"light",onClick:ep,leftSection:(0,n.jsx)(S.A,{size:16}),children:"断开"})}):(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(w.Button,{onClick:()=>eh(),disabled:!t,leftSection:(0,n.jsx)(T.A,{size:16}),color:"blue",variant:"light",children:"加入"})})})]})}),G&&(0,n.jsxs)(p.Paper,{p:"md",withBorder:!0,radius:"md",children:[(0,n.jsxs)(d.Group,{justify:"space-between",align:"center",mb:"sm",children:[(0,n.jsx)(x.Text,{fw:500,children:"连接状态详情"}),(0,n.jsx)(h.Badge,{variant:"light",color:et,children:U?"已连接":"未连接"})]}),(0,n.jsxs)(j.SimpleGrid,{cols:{base:1,sm:2},spacing:"sm",children:[(0,n.jsxs)(d.Group,{justify:"space-between",p:"xs",style:{backgroundColor:"var(--mantine-color-gray-light)",borderRadius:4},children:[(0,n.jsx)(x.Text,{size:"sm",children:"WebRTC 连接状态:"}),(0,n.jsx)(h.Badge,{size:"sm",color:"connected"===L?"green":"connecting"===L?"yellow":"gray",children:L})]}),(0,n.jsxs)(d.Group,{justify:"space-between",p:"xs",style:{backgroundColor:"var(--mantine-color-gray-light)",borderRadius:4},children:[(0,n.jsx)(x.Text,{size:"sm",children:"ICE 连接状态:"}),(0,n.jsx)(h.Badge,{size:"sm",color:"connected"===N||"completed"===N?"green":"checking"===N?"yellow":"gray",children:N})]})]}),!U&&G&&(0,n.jsx)(x.Text,{size:"sm",c:"dimmed",mt:"sm",children:"\uD83D\uDCA1 提示: 如果长时间无法建立 P2P 连接，请检查网络 IPv6 配置或尝试重新连接"}),U&&(0,n.jsxs)(d.Group,{mt:"sm",gap:"xs",children:[(0,n.jsx)(w.Button,{size:"xs",variant:"light",color:"blue",onClick:ed,children:"延迟"}),_&&(0,n.jsxs)(x.Text,{size:"xs",c:"dimmed",children:["RTT:"," ",(null==(e=_.candidatePair)?void 0:e.currentRoundTripTime)?"".concat((1e3*_.candidatePair.currentRoundTripTime).toFixed(0),"ms"):"失败"]})]})]}),(0,n.jsxs)(j.SimpleGrid,{cols:{base:1,sm:2},spacing:"md",children:[(0,n.jsxs)(p.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,n.jsx)(l.Center,{children:(0,n.jsx)(x.Text,{children:"本地"})}),(0,n.jsx)("video",{ref:J,playsInline:!0,autoPlay:!0,muted:!0,"aria-label":"本地媒体流视频",title:"本地媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}})]}),(0,n.jsxs)(p.Paper,{p:"sm",withBorder:!0,radius:"md",children:[(0,n.jsx)(l.Center,{children:(0,n.jsx)(x.Text,{children:"远端"})}),(0,n.jsx)("video",{ref:q,playsInline:!0,autoPlay:!0,"aria-label":"远端媒体流视频",title:"远端媒体流视频",style:{width:"100%",maxWidth:560,borderRadius:8}})]})]}),(0,n.jsx)(b.Card,{withBorder:!0,children:(0,n.jsx)(v.Box,{className:em,ref:eg})})]})]})}}},e=>{e.O(0,[8198,2545,642,2646,5619,8798,8555,8990,5125,4245,9318,9457,3999,101,2655,8441,1255,7358],()=>e(e.s=13422)),_N_E=e.O()}]);