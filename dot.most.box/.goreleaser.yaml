version: 2
project_name: dot

dist: dist

before:
  hooks:
    - go mod tidy

builds:
  - id: dot
    main: ./cmd/server
    binary: dot
    env:
      - CGO_ENABLED=0
    flags:
      - -trimpath
    ldflags:
      - -s -w
      - -X dotmostbox/internal/update.Version={{ .Version }}
    goos:
      - windows
      - linux
      - darwin
    goarch:
      - amd64
      - arm64

archives:
  - id: binaries
    ids:
      - dot
    formats: ["binary"]
    name_template: >-
      {{ .Binary }}-{{ .Os }}-{{ .Arch }}

checksum:
  name_template: "checksums.txt"

changelog:
  use: git
  filters:
    exclude:
      - "^docs:"
      - "^test:"

release:
  replace_existing_artifacts: true

upx:
  - enabled: true
    ids: [dot]
    goos: [linux, windows]
    compress: best
    lzma: true
    brute: false

dockers_v2:
  - images:
      - docker.io/mostpeople/dot
    tags:
      - "{{ .Version }}"
      - "latest"
    dockerfile: ./Dockerfile
    platforms:
      - linux/amd64
      - linux/arm64
    labels:
      org.opencontainers.image.description: Dot service
      org.opencontainers.image.created: "{{ .Date }}"
      org.opencontainers.image.name: "{{ .ProjectName }}"
      org.opencontainers.image.revision: "{{ .FullCommit }}"
      org.opencontainers.image.version: "{{ .Version }}"
      org.opencontainers.image.source: "{{ .GitURL }}"
